<div class="module-view animate-fadeIn">
  <header class="module-header">
    <h2 class="module-title">Reporte de Movimientos de Cuentas</h2>
  </header>

  <div class="form-card animate-fadeIn">
    <div class="form-header">
      <h3>Filtros de Reporte</h3>
    </div>

    <form [formGroup]="form" (ngSubmit)="generarReporte()" class="form-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Identificador Bancario</label>
          <input
            type="text"
            formControlName="clienteId"
            [class.error]="isInvalid('clienteId')"
            placeholder="Ej: 423956470"
          />
          @if (isInvalid('clienteId')) {
            <span class="error-msg">ID requerido</span>
          }
        </div>

        <div class="form-group">
          <label>Fecha Inicio</label>
          <input
            type="date"
            formControlName="inicio"
            [max]="today"
            [class.error]="isInvalid('inicio')"
          />
          @if (isInvalid('inicio')) {
            <span class="error-msg">
              {{
                form.get('inicio')?.hasError('fechaFutura')
                  ? 'La fecha no puede ser futura'
                  : 'Fecha requerida'
              }}
            </span>
          }
        </div>

        <div class="form-group">
          <label>Fecha Fin</label>
          <input type="date" formControlName="fin" [max]="today" [class.error]="isInvalid('fin')" />
          @if (isInvalid('fin')) {
            <span class="error-msg">
              {{
                form.get('fin')?.hasError('fechaFutura')
                  ? 'La fecha no puede ser futura'
                  : 'Fecha requerida'
              }}
            </span>
          }
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary" [disabled]="form.invalid || loading()">
          {{ loading() ? 'Generando...' : 'Generar Reporte' }}
        </button>
      </div>
    </form>
  </div>

  @if (reporte()) {
    <div class="report-result animate-fadeIn">
      <div class="report-header-info">
        <div class="client-details">
          <span class="label">Cliente Titular</span>
          <h2 class="client-name">{{ reporte()?.cliente }}</h2>
        </div>
        <div class="range-details">
          <span class="label">Periodo del Reporte</span>
          <p>
            {{ form.get('inicio')?.value | date: 'dd/MM/yyyy' }} —
            {{ form.get('fin')?.value | date: 'dd/MM/yyyy' }}
          </p>
        </div>
      </div>

      <div class="summary-card-unified">
        <div class="summary-section">
          <div class="total-item credit">
            <small>Total Créditos (Depósitos)</small>
            <p>{{ reporte()?.totalCreditos | currency: 'USD' }}</p>
          </div>
          <div class="divider-vertical"></div>
          <div class="total-item debit">
            <small>Total Débitos (Retiros)</small>
            <p>{{ reporte()?.totalDebitos | currency: 'USD' }}</p>
          </div>
        </div>
        <div class="action-section">
          <button type="button" class="btn-pdf-blue" (click)="descargarPdf()">Descargar PDF</button>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>N° Cuenta</th>
              <th>Tipo Mov.</th>
              <th>Saldo Inicial</th>
              <th>Movimiento</th>
              <th>Saldo Disponible</th>
            </tr>
          </thead>
          <tbody>
            @for (mov of reporte()?.movimientos; track $index) {
              <tr>
                <td>{{ mov['Fecha'] }}</td>
                <td>
                  <strong>{{ mov['Numero Cuenta'] }}</strong>
                </td>
                <td>
                  <span class="badge" [ngClass]="mov['Movimiento'] < 0 ? 'bg-red' : 'bg-green'">
                    {{ mov['Tipo'] }}
                  </span>
                </td>
                <td>{{ mov['Saldo Inicial'] | currency: 'USD' }}</td>
                <td
                  [ngClass]="mov['Movimiento'] < 0 ? 'text-danger' : 'text-success'"
                  class="fw-bold"
                >
                  {{ mov['Movimiento'] | currency: 'USD' }}
                </td>
                <td>
                  <strong>{{ mov['Saldo Disponible'] | currency: 'USD' }}</strong>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</div>
